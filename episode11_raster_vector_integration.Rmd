---
title: "Raster and vetor integration"
output:
  html_document:
    toc: true
    toc_depth: 2
  theme: united
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,warning = FALSE, message = FALSE)
```


This episode explains how to crop a raster using the extent of a vector
shapefile. We will also cover how to extract values from a raster that occur
within a set of polygons, or in a buffer (surrounding) region around a set of
points.


**Objectives**

- Crop a raster to the extent of a vector layer.
- Extract values from a raster that correspond to a vector file overlay.

**Keypoints**

- Use the `crop()` function to crop a raster object.
- Use the `extract()` function to extract pixels from a raster object that fall within a particular extent boundary.
- Use the `extent()` function to define an extent.

If you're just opening up this project, you'll have to load the packages and data used in previous episodes. 
```{r prep-environment, echo = TRUE, results='hide', message = FALSE, warning = FALSE}

# load packages 
library(raster)
library(rgdal)
library(ggplot2)
library(dplyr)
library(sf)


# data loaded from earlier episode
# DSM data for Harvard Forest
dtm <- raster("data/raster/HARV_dtmCrop.tif")
dtm_df <- as.data.frame(dtm, xy = TRUE)

tower <- st_read("data/vector/HARVtower_UTM18N.shp")
roads <- st_read("data/vector/HARV_roads.shp")
aoi_boundary <- st_read("data/vector/HarClip_UTMZ18.shp")
```

# Import a Canopy Height Model (CHM)
Previously we worked with a Digital Terrain Model (DTM) for Harvard Forest. This DTM represents the ground elevation. We will now work with a Canopy Height Model (CHM) for the same area. The CHM is a NEON data product and was created using the LiDAR data. A CHM can be generated by subtracting a DTM from a Digital Surface Model (DSM).

If you would like more information about how to generate a CHM from other LiDAR data product, review the [Raster Calculations](https://datacarpentry.org/r-raster-vector-geospatial/04-raster-calculations-in-r/index.html) episode.

We will import a CHM for Harvard Forest using the `raster()` function. Since we would like to plot the data, we will also convert it to a data frame.

```{r import-chm}

# import CHM
chm <- raster("data/raster/HARV_chmCrop.tif")
chm_df <- as.data.frame(chm,xy=T)

```

# Plot raster and vector data

We often work with spatial layers that have different spatial extents. The
spatial extent of a shapefile or R spatial object represents the geographic
"edge" or location that is the furthest north, south east and west. Thus is
represents the overall geographic coverage of the spatial object.

Let's start by plotting the full extent of the CHM data and overlay where the AOI falls within it. The boundaries of the AOI will be colored blue, and we use `fill = NA` to make the area transparent.

```{r crop-by-vector-extent}

ggplot() +
  geom_raster(data = chm_df, aes(x = x, y = y, fill = HARV_chmCrop)) + 
  scale_fill_gradientn(name = "Canopy Height", colors = terrain.colors(10)) +
  geom_sf(data = aoi_boundary, color = "blue", fill = NA) +
  geom_sf(data = tower) +
  coord_sf()
```

# Crop raster by polygon vector

Now that we have visualized the area of the CHM we want to subset, we can
perform the cropping operation. We are going to `crop()` function from the 
raster package to create a new object with only the portion of the CHM data 
that falls within the boundaries of the AOI.

```{r crop-chm}

# use the aoi boundary to crop the chm
chm_cropped <- crop(x = chm, y = aoi_boundary)
```

Our new cropped CHM now has the same extent
as the `aoi_boundary_HARV` object that was used as a crop extent (blue border
below).


``` {r view-extent}

# view bounding box of raster and polygon objects
# can use the same st_bbox function
st_bbox(chm_cropped)
st_bbox(aoi_boundary)
```

```{r plot-crop}

chm_cropped_df <- as.data.frame(chm_cropped, xy = TRUE)
ggplot() +
  geom_raster(data = chm_cropped_df, aes(x = x, y = y, fill = HARV_chmCrop)) +
  geom_sf(data = tower) +
  scale_fill_gradientn(name = "Canopy Height", colors = terrain.colors(10)) + 
  coord_sf()

```


# Extract raster pixel values using vector data 

Often we want to extract values from a raster layer for particular locations -
for example, plot locations that we are sampling on the ground. We can extract all pixel values within 20m of our x,y point of interest. These can then be summarized into some value of interest (e.g. mean, maximum, total).

To do this in R, we use the `extract()` function. The `extract()` function
requires:

* The raster that we wish to extract values from,
* The vector layer containing the polygons that we wish to use as a boundary or
boundaries,
* we can tell it to store the output values in a data frame using
`df = TRUE`. (This is optional, the default is to return a list, NOT a data frame.) .

We will begin by extracting all canopy height pixel values located within our
`aoi_boundary` polygon which surrounds the tower located at the NEON Harvard
Forest field site.

```{r extract-from-raster}

# extract chm values within aoi boundary
tree_height <- extract(x = chm, y = aoi_boundary, df = TRUE)
str(tree_height)

```

When we use the `extract()` function, R extracts the value for each pixel located
within the boundary of the polygon being used to perform the extraction - in
this case the `aoi_boundary` object (a single polygon). Here, the
function extracted values from 18,450 pixels.

We can create a histogram of tree height values within the boundary to better
understand the structure or height distribution of trees at our site. We will
use the column `layer` from our data frame as our x values, as this column
represents the tree heights for each pixel.

```{r view-extract-histogram}

ggplot() + 
  geom_histogram(data = tree_height, aes(x = HARV_chmCrop)) +
  ggtitle("Histogram of CHM Height Values (m)") +
  xlab("Tree Height") + 
  ylab("Frequency of Pixels")
```

# Summarize Extracted Raster Values

We often want to extract summary values from a raster. We can tell R the type
of summary statistic we are interested in using the `fun =` argument. Let's extract
a mean height value for our AOI. Because we are extracting only a single number, we will
not use the `df = TRUE` argument. 

```{r summarize-extract }

# extract, find the mean
mean_tree_height_aoi <- extract(x = chm, y = aoi_boundary, fun = mean)
mean_tree_height_aoi

```

It appears that the mean height value, extracted from our LiDAR data derived
canopy height model is 22.43 meters.

# Extract Data using x,y Locations

We can also extract pixel values from a raster by defining a buffer or area
surrounding individual point locations using the `extract()` function. To do this
we define the summary argument (`fun = mean`) and the buffer distance (`buffer = 20`)
which represents the radius of a circular region around each point. By default, the units of the buffer are the same units as the data's CRS. All pixels that are touched by the buffer region are included in the extract.

Let's put this into practice by figuring out the mean tree height in the
20m around the tower location (`point_HARV`). Because we are extracting only a single number, we will not use the `df = TRUE` argument. 

```{r extract-point-to-buffer }
mean_tree_height_tower <- extract(x = chm,
                                  y = tower,
                                  buffer = 20,
                                  fun = mean)
mean_tree_height_tower
```



The material has been adapted from The Carpentries [Introduction to Geospatial Raster and Vector Data with R](https://datacarpentry.org/r-raster-vector-geospatial/01-raster-structure/index.html) lesson licensed under [CC-BY 4.0](https://creativecommons.org/licenses/by/4.0/)
